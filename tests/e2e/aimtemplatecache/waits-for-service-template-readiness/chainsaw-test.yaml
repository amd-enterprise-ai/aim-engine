apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: template-cache-waits-for-template-readiness
spec:
  description: |
    Tests that the template cache waits for the service template to become ready.
    When the service template is not ready (e.g., discovery in progress or failing),
    the template cache should reflect that it cannot proceed yet.
  steps:
    - name: Create the model and service template
      try:
        - apply:
            file: model.yaml
        - apply:
            file: service-template.yaml

    - name: Create the template cache
      try:
        - apply:
            file: template-cache.yaml

    - name: Ensure the template cache is not Ready while template is not ready
      description: |
        The service template will struggle with discovery (fake image can't be pulled).
        The template cache should NOT be Ready - it will be Pending or Failed
        depending on the current state of the service template.
      try:
        - assert:
            timeout: 30s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMTemplateCache
              metadata:
                name: waits-for-template-readiness
              status:
                (conditions[?type == 'Ready']):
                  - status: "False"

    - name: Verify the service template is also not ready
      try:
        - assert:
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: waits-for-template-readiness
              status:
                (conditions[?type == 'Ready']):
                  - status: "False"
