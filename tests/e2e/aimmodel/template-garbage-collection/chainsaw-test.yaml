# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
#
# AIMModel Test: Template Garbage Collection
#
# This test validates that auto-created service templates are garbage collected
# when the parent model is deleted (via owner references).
#
# Tested behavior:
# - Templates are created with owner references to the model
# - Deleting the model causes templates to be garbage collected
#
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: template-garbage-collection
spec:
  steps:
    - name: Create model with templates
      try:
        - apply:
            file: model.yaml

    - name: Assert templates are created
      try:
        - assert:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                labels:
                  aim.eai.amd.com/model: test-gc-model

    - name: Delete the model
      try:
        - delete:
            ref:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMModel
              name: test-gc-model

    - name: Assert templates are garbage collected
      try:
        - error:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                labels:
                  aim.eai.amd.com/model: test-gc-model
