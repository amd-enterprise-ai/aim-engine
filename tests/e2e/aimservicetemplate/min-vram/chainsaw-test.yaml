# Tests minVRAM requirement in AIMServiceTemplate.
# Verifies that minVram is properly copied to resolvedHardware.
#
# Assumes the cluster has a GPU that meets the minVram requirement
# (found via static device ID mapping in KnownGPUVRAM).
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: servicetemplate-min-vram
spec:
  description: Test that minVram requirement is propagated to resolvedHardware
  timeouts:
    assert: 60s
  steps:
    - name: Create model with dummy image
      try:
        - apply:
            file: model.yaml

    - name: Create template with minVram requirement
      try:
        - apply:
            file: template.yaml

    - name: Verify template becomes Ready
      try:
        - assert:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-min-vram-template
              status:
                status: Ready

    - name: Verify minVram is copied to resolvedHardware
      try:
        - assert:
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-min-vram-template
              status:
                resolvedHardware:
                  gpu:
                    requests: 1
                    minVram: 64Gi

    - name: Verify GPUReady condition is True
      try:
        - assert:
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-min-vram-template
              status:
                (conditions[?type == 'GPUReady']):
                  - status: "True"
                    reason: GPUAvailable

    # Test VRAMNotAvailable condition - 1Ti exceeds any known GPU
    - name: Create template with excessive minVram requirement
      try:
        - apply:
            file: template-vram-too-high.yaml

    - name: Verify template becomes NotAvailable with VRAMNotAvailable
      try:
        - assert:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-min-vram-too-high
              status:
                status: NotAvailable
                (conditions[?type == 'GPUReady']):
                  - status: "False"
                    reason: VRAMNotAvailable
