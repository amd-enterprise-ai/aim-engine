apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: servicetemplate-inline-modelsources
spec:
  description: Test that providing modelSources in-line skips discovery and template becomes ready immediately
  timeouts:
    assert: 60s
  steps:
    - name: Create namespace-scoped model
      try:
        - apply:
            file: model.yaml

    - name: Create template with inline modelSources
      try:
        - apply:
            file: template.yaml

    - name: Wait for template to become Ready
      try:
        - assert:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-template-inline-modelsources
              status:
                status: Ready

    - name: Verify modelSources were copied from spec to status
      try:
        - assert:
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-template-inline-modelsources
              status:
                modelSources:
                  - name: amd/Llama-3.1-8B-Instruct-FP8-KV
                    sourceUri: hf://amd/Llama-3.1-8B-Instruct-FP8-KV
                    size: "9094593249"

    - name: Verify Discovered condition shows inline sources
      try:
        - assert:
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-template-inline-modelsources
              status:
                (conditions[?type == 'Discovered']):
                  - status: "True"
                    reason: InlineModelSources
                    message: Model sources provided in-line in spec

    - name: Verify no discovery job was created
      try:
        - error:
            resource:
              apiVersion: batch/v1
              kind: Job
              metadata:
                labels:
                  aim.eai.amd.com/template: test-template-inline-modelsources

    - name: Verify resolved model reference in status
      try:
        - assert:
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-template-inline-modelsources
              status:
                resolvedModel:
                  name: test-model-inline

