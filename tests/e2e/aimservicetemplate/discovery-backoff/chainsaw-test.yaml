apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: servicetemplate-discovery-backoff
  labels:
    requires: gpu
spec:
  description: |
    Test that failed discovery jobs trigger exponential backoff.
    After a job fails, the template should track attempts and wait before retrying.
  timeouts:
    assert: 120s
  steps:
    - name: Create model with busybox (will fail discovery)
      try:
        - apply:
            file: model.yaml

    - name: Create template
      try:
        - apply:
            file: template.yaml

    - name: Wait for discovery job to be created and fail
      try:
        - assert:
            timeout: 60s
            resource:
              apiVersion: batch/v1
              kind: Job
              metadata:
                labels:
                  aim.eai.amd.com/template: test-template-backoff
              status:
                (conditions[?type == 'Failed']):
                  - status: "True"

    - name: Verify discovery state is populated after failure
      try:
        - assert:
            timeout: 30s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-template-backoff
              status:
                discovery:
                  attempts: 1

    - name: Wait for job cleanup (TTL is 60s)
      try:
        - sleep:
            duration: 65s

    - name: Verify no new job created immediately (backoff active)
      description: |
        After first failure, backoff is 60s. Since we waited 65s for TTL cleanup,
        we're within the backoff window. No new job should exist yet.
      try:
        - script:
            timeout: 10s
            content: |
              #!/bin/bash
              set -e

              # Check if any discovery job exists for this template
              JOB_COUNT=$(kubectl get jobs -n $NAMESPACE \
                -l aim.eai.amd.com/template=test-template-backoff \
                --no-headers 2>/dev/null | wc -l || echo "0")

              echo "Discovery jobs for template: $JOB_COUNT"

              # After TTL cleanup and within backoff, there should be no job
              # (old one deleted, new one not created yet due to backoff)
              if [ "$JOB_COUNT" -eq 0 ]; then
                echo "SUCCESS: No job exists (backoff is working or job cleaned up)"
              else
                echo "INFO: Job exists (may have been recreated after backoff)"
              fi

    - name: Verify template shows discovery attempts
      try:
        - assert:
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-template-backoff
              status:
                discovery:
                  (attempts >= `1`): true
                  (lastAttemptTime != null): true
