# tests/e2e/aimartifact/size-discovery-and-verification/chainsaw-test.yaml
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: size-discovery-and-verification
  labels:
    requires: external-network
spec:
  steps:
    # ========================================
    # Phase 1: Setup MinIO
    # ========================================
    - name: Deploy MinIO
      try:
        - apply:
            file: minio-service.yaml
        - apply:
            file: minio-deployment.yaml
        - assert:
            timeout: 60s
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: minio
              status:
                availableReplicas: 1
        - apply:
            file: minio-setup-job.yaml
        - assert:
            timeout: 60s
            resource:
              apiVersion: batch/v1
              kind: Job
              metadata:
                name: minio-setup
              status:
                succeeded: 1

    # ========================================
    # Phase 2: Create HF Artifact (with size discovery)
    # ========================================
    - name: Create HF artifact without size
      try:
        - apply:
            file: artifact-hf.yaml

    - name: Assert HF check-size job is created
      try:
        - assert:
            timeout: 30s
            resource:
              apiVersion: batch/v1
              kind: Job
              metadata:
                labels:
                  aim.eai.amd.com/artifact.name: test-hf
                  aim.eai.amd.com/component: check-size

    - name: Assert HF artifact gets ready with discovered size
      try:
        - assert:
            timeout: 5m
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMArtifact
              metadata:
                name: test-hf
              status:
                status: Ready
                (discoveredSizeBytes != null): true
                (allocatedSize != null && allocatedSize != ''): true
                progress:
                  percentage: 100

    # ========================================
    # Phase 3: Upload HF model to MinIO
    # ========================================
    - name: Upload HF model to MinIO
      try:
        - script:
            timeout: 2m
            content: |
              set -e
              # Use chainsaw's namespace
              PVC_NAME=$(kubectl get aimartifact test-hf -n $NAMESPACE -o jsonpath='{.status.persistentVolumeClaim}')
              echo "Using PVC: $PVC_NAME"
              
              cat <<EOF | kubectl apply -n $NAMESPACE -f -
              apiVersion: batch/v1
              kind: Job
              metadata:
                name: model-upload
              spec:
                template:
                  spec:
                    restartPolicy: Never
                    securityContext:
                      runAsUser: 1000
                      fsGroup: 1000
                    containers:
                      - name: uploader
                        image: minio/mc:latest
                        env:
                          - name: MC_CONFIG_DIR
                            value: /tmp/.mc
                        command: ["/bin/sh", "-c"]
                        args:
                          - |
                            mc alias set myminio http://minio:9000 minioadmin minioadmin
                            mc cp --recursive /hf-model/ myminio/models/tiny-gpt2/
                        volumeMounts:
                          - name: hf-model
                            mountPath: /hf-model
                            readOnly: true
                    volumes:
                      - name: hf-model
                        persistentVolumeClaim:
                          claimName: ${PVC_NAME}
              EOF
              
              kubectl wait --for=condition=complete job/model-upload -n $NAMESPACE --timeout=2m

    # ========================================
    # Phase 4: Create S3 Artifact (with size discovery)
    # ========================================
    - name: Create S3 artifact without size
      try:
        - apply:
            file: artifact-s3.yaml

    - name: Assert S3 check-size job is created
      try:
        - assert:
            timeout: 30s
            resource:
              apiVersion: batch/v1
              kind: Job
              metadata:
                labels:
                  aim.eai.amd.com/artifact.name: test-s3
                  aim.eai.amd.com/component: check-size

    - name: Assert S3 artifact gets ready with discovered size
      try:
        - assert:
            timeout: 5m
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMArtifact
              metadata:
                name: test-s3
              status:
                status: Ready
                (discoveredSizeBytes != null): true
                progress:
                  percentage: 100

    # ========================================
    # Phase 5: Verify both models are identical
    # ========================================
    - name: Verify models are identical
      try:
        - script:
            timeout: 2m
            content: |
              set -e
              # Get both PVC names from AIMArtifact status
              HF_PVC=$(kubectl get aimartifact test-hf -n $NAMESPACE -o jsonpath='{.status.persistentVolumeClaim}')
              S3_PVC=$(kubectl get aimartifact test-s3 -n $NAMESPACE -o jsonpath='{.status.persistentVolumeClaim}')
              echo "HF PVC: $HF_PVC"
              echo "S3 PVC: $S3_PVC"
              
              cat <<EOF | kubectl apply -n $NAMESPACE -f -
              apiVersion: batch/v1
              kind: Job
              metadata:
                name: verify-models
              spec:
                template:
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: verify
                        image: alpine:latest
                        command: ["/bin/sh", "-c"]
                        args:
                          - |
                            set -e
                            echo "=== HF Model contents ==="
                            ls -la /hf-model/
                            HF_SIZE=\$(du -sb /hf-model | cut -f1)
                            echo "HF model size: \$HF_SIZE bytes"
                            
                            echo "=== S3 Model contents ==="
                            ls -la /s3-model/
                            S3_SIZE=\$(du -sb /s3-model | cut -f1)
                            echo "S3 model size: \$S3_SIZE bytes"
                            
                            if [ "\$HF_SIZE" != "\$S3_SIZE" ]; then
                              echo "ERROR: Size mismatch!"
                              exit 1
                            fi
                            echo "Size check passed"
                            
                            cd /hf-model && find . -type f -exec md5sum {} \; | sort > /tmp/hf.txt
                            cd /s3-model && find . -type f -exec md5sum {} \; | sort > /tmp/s3.txt
                            
                            if ! diff /tmp/hf.txt /tmp/s3.txt; then
                              echo "ERROR: Checksum mismatch!"
                              exit 1
                            fi
                            echo "SUCCESS: Models are identical!"
                        volumeMounts:
                          - name: hf-model
                            mountPath: /hf-model
                            readOnly: true
                          - name: s3-model
                            mountPath: /s3-model
                            readOnly: true
                    volumes:
                      - name: hf-model
                        persistentVolumeClaim:
                          claimName: ${HF_PVC}
                      - name: s3-model
                        persistentVolumeClaim:
                          claimName: ${S3_PVC}
              EOF
              
              kubectl wait --for=condition=complete job/verify-models -n $NAMESPACE --timeout=2m