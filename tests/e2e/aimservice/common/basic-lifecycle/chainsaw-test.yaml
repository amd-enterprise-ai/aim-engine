# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
#
# AIMService E2E Test: Basic Lifecycle (Kind)
#
# This test validates the full end-to-end lifecycle of an AIMService on Kind:
# 1. Create AIMModel with the aim-dummy image
# 2. Create AIMServiceTemplate referencing the model
# 3. Wait for template discovery to complete
# 4. Create AIMService referencing the model and template
# 5. Verify the service progresses through its lifecycle
#
# Uses: ghcr.io/silogen/aim-dummy:0.1.10 (lightweight test image)
#
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: aimservice-basic-lifecycle
spec:
  description: Test full AIMService lifecycle from model creation to service deployment
  timeouts:
    assert: 180s
  steps:
    - name: Create model
      try:
        - apply:
            file: model.yaml

    - name: Create service template
      try:
        - apply:
            file: template.yaml

    - name: Wait for template discovery to complete
      try:
        - assert:
            timeout: 120s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMServiceTemplate
              metadata:
                name: test-service-template
              status:
                status: Ready

    - name: Create service
      try:
        - apply:
            file: service.yaml

    - name: Verify service resolves model and template
      try:
        - assert:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMService
              metadata:
                name: test-service
              status:
                resolvedModel:
                  name: test-service-model
                resolvedTemplate:
                  name: test-service-template
                (conditions[?type == 'ModelReady']):
                  - status: "True"
                (conditions[?type == 'TemplateReady']):
                  - status: "True"

    - name: Verify service starts (creates InferenceService)
      try:
        - assert:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMService
              metadata:
                name: test-service
              status:
                status: Starting

    - name: Verify InferenceService is created
      try:
        - assert:
            timeout: 5m
            resource:
              apiVersion: serving.kserve.io/v1beta1
              kind: InferenceService
              metadata:
                labels:
                  aim.eai.amd.com/service: test-service

    - name: Verify service reaches Running status
      try:
        - assert:
            timeout: 180s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMService
              metadata:
                name: test-service
              status:
                status: Running
