# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
#
# AIMService E2E Test: Cache Cleanup - Failed Caches Deleted
#
# This test validates that when an AIMService is deleted, Failed template caches
# and artifacts ARE deleted (to allow clean recreation).
#
# Test flow:
# 1. Create AIMRuntimeConfig with AIM_DEBUG_CAUSE_FAILURE env (causes download to fail)
# 2. Create AIMService with model.image and caching.mode: Always
# 3. Wait for the artifact to fail
# 4. Delete the AIMService
# 5. Verify the template cache and artifact are deleted (cleaned up because Failed)
#
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: aimservice-cache-cleanup-failed-deleted
spec:
  description: Test that Failed caches are deleted when AIMService is deleted
  timeouts:
    assert: 180s
  steps:
    - name: Create runtime config with failure trigger
      try:
        - apply:
            file: runtimeconfig.yaml

    - name: Create service with caching enabled
      try:
        - apply:
            file: service.yaml

    - name: Wait for template cache to be created
      try:
        - assert:
            timeout: 120s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMTemplateCache
              metadata:
                labels:
                  aim.eai.amd.com/service.name: cache-cleanup-fail-service

    - name: Verify AIMArtifact is created and reaches Failed status
      try:
        - assert:
            timeout: 120s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMArtifact
              metadata:
                labels:
                  aim.eai.amd.com/service.name: cache-cleanup-fail-service
              status:
                status: Failed

    - name: Verify template cache reflects failure
      try:
        - assert:
            timeout: 2m
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMTemplateCache
              metadata:
                labels:
                  aim.eai.amd.com/service.name: cache-cleanup-fail-service
              status:
                status: Failed

    - name: Delete the AIMService
      try:
        - delete:
            ref:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMService
              name: cache-cleanup-fail-service

    - name: Verify AIMTemplateCache is deleted (cascade from service finalizer)
      try:
        - error:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMTemplateCache
              metadata:
                labels:
                  aim.eai.amd.com/service.name: cache-cleanup-fail-service

    - name: Verify AIMArtifact is deleted (cascade from template cache finalizer)
      try:
        - error:
            timeout: 60s
            resource:
              apiVersion: aim.eai.amd.com/v1alpha1
              kind: AIMArtifact
              metadata:
                labels:
                  aim.eai.amd.com/service.name: cache-cleanup-fail-service
