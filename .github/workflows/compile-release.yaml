name: compile-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.2.3). Falls back to tag if empty.'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  compile-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
      chart_version: ${{ steps.ver.outputs.chart_version }}
    env:
      BUILD_IMAGES: ${{ vars.BUILD_IMAGES }}
      PUSH_IMAGE_REPO: ${{ vars.PUSH_IMAGE_REPO }}
      PULL_IMAGE_REPO: ${{ vars.PULL_IMAGE_REPO }}
      CHART_IMAGE_REPO: ${{ vars.CHART_IMAGE_REPO || vars.PULL_IMAGE_REPO }}
      CHART_NAME: aim-engine-chart

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up mise
        uses: jdx/mise-action@v2

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Determine version
        id: ver
        run: |
          INPUT_VERSION="${{ inputs.version }}"
          if [ -n "${INPUT_VERSION}" ]; then
            VERSION="${INPUT_VERSION}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          CHART_VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "CHART_VERSION=${CHART_VERSION}" >> "$GITHUB_ENV"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "chart_version=${CHART_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using version: ${VERSION}, chart version: ${CHART_VERSION}"

      - name: Log in to GHCR (Docker)
        if: env.BUILD_IMAGES == 'true'
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Build and push Docker image
        if: env.BUILD_IMAGES == 'true'
        run: |
          make docker-build IMG=${PUSH_IMAGE_REPO}:${VERSION}
          make docker-push IMG=${PUSH_IMAGE_REPO}:${VERSION}

      - name: Verify image exists
        if: env.BUILD_IMAGES != 'true'
        run: |
          echo "Verifying image ${PULL_IMAGE_REPO}:${VERSION} is available..."
          docker pull ${PULL_IMAGE_REPO}:${VERSION}

      - name: Update Helm values with image
        run: |
          sed -i "s|repository: .*|repository: ${CHART_IMAGE_REPO}|" config/helm/values.yaml
          sed -i "s|tag: .*|tag: ${VERSION}|" config/helm/values.yaml

      - name: Generate CRDs
        run: make crds

      - name: Package Helm chart
        run: |
          make helm-package TAG=${VERSION} CHART_VERSION=${CHART_VERSION}

      - name: Validate chart with helm template
        run: helm template aim-engine ./dist/chart > /dev/null

      - name: Lint Helm chart
        run: helm lint ./dist/chart

      - name: Package CRDs as Helm chart
        run: |
          make crds-package CHART_VERSION=${CHART_VERSION} TAG=${VERSION}

      - name: Generate install.yaml
        run: |
          make build-installer IMG=${PULL_IMAGE_REPO}:${VERSION}

      - name: Log in to GHCR (Helm/OCI)
        if: env.BUILD_IMAGES == 'true'
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Push Helm chart to OCI registry
        if: env.BUILD_IMAGES == 'true'
        run: |
          make helm-push-oci CHART_VERSION=${CHART_VERSION} CHART_OCI_OWNER=${{ github.repository_owner }}

      - name: Push CRDs chart to OCI registry
        if: env.BUILD_IMAGES == 'true'
        run: |
          make crds-push-oci CHART_VERSION=${CHART_VERSION} CHART_OCI_OWNER=${{ github.repository_owner }}

      - name: Upload install.yaml artifact
        uses: actions/upload-artifact@v4
        with:
          name: install-yaml
          path: dist/install.yaml

      - name: Upload Helm chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: dist/${{ env.CHART_NAME }}-${{ env.CHART_VERSION }}.tgz

      - name: Upload CRDs artifact
        uses: actions/upload-artifact@v4
        with:
          name: crds-yaml
          path: dist/crds.yaml

      - name: Upload CRDs chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: crds-chart
          path: dist/aim-engine-crds-chart-${{ env.CHART_VERSION }}.tgz

      - name: Create draft release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/install.yaml
            dist/crds.yaml
            dist/${{ env.CHART_NAME }}-${{ env.CHART_VERSION }}.tgz
            dist/aim-engine-crds-chart-${{ env.CHART_VERSION }}.tgz
          token: '${{ secrets.GITHUB_TOKEN }}'
          draft: true
          prerelease: true
          body: |
            ## Installation

            ### Quick Install (kubectl)
            ```bash
            kubectl apply -f https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/install.yaml --server-side
            ```

            ### Helm Install

            CRDs are distributed separately and must be installed first:

            ```bash
            # 1a. Install CRDs via Helm OCI (recommended)
            helm install aim-engine-crds oci://ghcr.io/${{ github.repository_owner }}/aim-engine-crds-chart \
              --version ${{ steps.ver.outputs.chart_version }}
            ```

            ```bash
            # 1b. Or install CRDs from manifest
            kubectl apply -f https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/crds.yaml
            kubectl wait --for=condition=Established crd --all --timeout=60s
            ```

            ```bash
            # 2a. Install operator via Helm OCI (recommended)
            helm install aim-engine oci://ghcr.io/${{ github.repository_owner }}/aim-engine-chart \
              --version ${{ steps.ver.outputs.chart_version }} \
              --namespace aim-system --create-namespace
            ```

            ```bash
            # 2b. Or install from GitHub Releases tarball
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/aim-engine-chart-${{ steps.ver.outputs.chart_version }}.tgz -o aim-engine.tgz
            helm install aim-engine aim-engine.tgz --namespace aim-system --create-namespace
            ```

            ### Docker Images
            - Operator: `${{ env.CHART_IMAGE_REPO }}:${{ env.VERSION }}`

      - name: Create or update artifacts branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create orphan branch
          git checkout --orphan artifacts-temp || true
          
          # Clear the index
          git rm -rf --cached . || true
          
          # Add the chart directory
          mkdir -p chart
          cp -r dist/chart/* chart/
          git add chart/
          
          # Add the crd directory with crds.yaml as separate file (distributed independently)
          mkdir -p crd
          cp dist/crds.yaml crd/crds.yaml
          git add crd/crds.yaml
          
          # Create a README for the branch
          cat > README.md << 'EOF'
          # aim-engine
          
          This branch contains the auto-generated Helm chart and CRDs for aim-engine.
          
          ## Installation
          
          CRDs are distributed separately and must be installed first:
          
          ```bash
          # 1. Install CRDs
          kubectl apply -f https://raw.githubusercontent.com/${{ github.repository }}/artifacts/crd/crds.yaml
          kubectl wait --for=condition=Established crd --all --timeout=60s
          
          # 2a. Install operator via Helm OCI (recommended)
          helm install aim-engine oci://ghcr.io/${{ github.repository_owner }}/aim-engine-chart \
            --version ${{ steps.ver.outputs.chart_version }} \
            --namespace aim-system --create-namespace
          
          # 2b. Or install from this branch
          helm install aim-engine ./chart --namespace aim-system --create-namespace
          ```
          
          Or clone this branch:
          
          ```bash
          git clone -b artifacts https://github.com/${{ github.repository }}.git aim-engine
          cd aim-engine
          
          kubectl apply -f crd/crds.yaml
          kubectl wait --for=condition=Established crd --all --timeout=60s
          helm install aim-engine ./chart --namespace aim-system --create-namespace
          ```
          
          ## Source
          
          Generated from tag: ${{ env.VERSION }} (commit: ${{ github.sha }})
          EOF
          git add README.md
          
          # Commit
          git commit -m "Release ${VERSION}" --allow-empty
          
          # Force push to artifacts branch
          git push origin HEAD:artifacts --force

  test-release:
    runs-on: ubuntu-latest
    needs: compile-release
    env:
      VERSION: ${{ needs.compile-release.outputs.version }}
      CHART_VERSION: ${{ needs.compile-release.outputs.chart_version }}
      PULL_IMAGE_REPO: ${{ vars.PULL_IMAGE_REPO }}
      PUSH_IMAGE_REPO: ${{ vars.PUSH_IMAGE_REPO }}
      BUILD_IMAGES: ${{ vars.BUILD_IMAGES }}
      CHART_OCI_REPO: ${{ vars.CHART_OCI_REPO || format('oci://ghcr.io/{0}', github.repository_owner) }}
    steps:
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go \
            /opt/hostedtoolcache/Python /opt/hostedtoolcache/Ruby \
            /opt/hostedtoolcache/node /opt/hostedtoolcache/Java* \
            /usr/local/share/boost /usr/local/share/chromium \
            /usr/local/share/powershell /usr/local/share/vcpkg \
            /usr/local/lib/heroku /usr/local/lib/node_modules \
            /usr/share/swift /usr/share/miniconda /usr/share/az_* \
            /opt/az /opt/microsoft /opt/pipx
          sudo apt-get clean 2>/dev/null || true
          sudo docker image prune -af
          echo "After cleanup:"
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2
        env:
          MISE_LOCAL_CONFIG_ALLOWED: "0"

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - name: Create Kind cluster
        run: kind create cluster --config hack/kind/config.yaml

      - name: Install Kind dependencies (NFS provisioner)
        run: |
          for i in 1 2 3; do
            helmfile sync -f hack/kind/helmfile.yaml.gotmpl && break
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

      - name: Install core dependencies
        run: |
          for i in 1 2 3; do
            helmfile sync -f hack/dependencies/helmfile.yaml.gotmpl && break
            echo "Attempt $i failed, retrying in 15s..."
            sleep 15
          done

      - name: Log in to GHCR (Helm/OCI)
        if: env.BUILD_IMAGES == 'true'
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Install CRDs via Helm OCI
        run: |
          helm install aim-engine-crds ${CHART_OCI_REPO}/aim-engine-crds-chart \
            --version ${CHART_VERSION}

      - name: Create namespace
        run: kubectl create namespace aim-system

      - name: Create GHCR image pull secret
        if: env.BUILD_IMAGES == 'true'
        run: |
          kubectl create secret docker-registry ghcr-regcred \
            --namespace aim-system \
            --docker-server=ghcr.io \
            --docker-username=$GITHUB_ACTOR \
            --docker-password=${{ secrets.GITHUB_TOKEN }}

      - name: Install operator via Helm OCI
        run: |
          HELM_SET_ARGS=""
          if [ "${BUILD_IMAGES}" = "true" ]; then
            HELM_SET_ARGS="--set manager.image.repository=${PUSH_IMAGE_REPO} --set manager.image.tag=${VERSION} --set manager.imagePullSecrets[0].name=ghcr-regcred"
          fi
          helm install aim-engine ${CHART_OCI_REPO}/aim-engine-chart \
            --version ${CHART_VERSION} \
            --namespace aim-system \
            ${HELM_SET_ARGS}

      - name: Wait for operator to be ready
        run: kubectl wait --for=condition=Available --timeout=120s deployment/aim-engine-controller-manager -n aim-system

      - name: Debug operator status
        if: always()
        run: |
          echo "=== Operator Deployment ==="
          kubectl get deployment -n aim-system
          echo "=== Operator Pods ==="
          kubectl get pods -n aim-system
          echo "=== Operator Pod Describe ==="
          kubectl describe pods -n aim-system -l control-plane=controller-manager || true
          echo "=== Operator Logs (last 50 lines) ==="
          kubectl logs -n aim-system -l control-plane=controller-manager --tail=50 || true
          echo "=== CRDs ==="
          kubectl get crds | grep aim || true

      - name: Run Chainsaw tests
        run: make test-chainsaw-kind

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Operator Logs (full) ==="
          kubectl logs -n aim-system -l control-plane=controller-manager --tail=200 || true
          echo "=== All AIM resources ==="
          kubectl get aimservice,aimmodel,aimtemplatecache,aimartifact -A || true
          echo "=== Pods across all namespaces ==="
          kubectl get pods -A || true
          echo "=== Non-running pods ==="
          kubectl get pods -A --field-selector 'status.phase!=Running,status.phase!=Succeeded' || true
          echo "=== Events (warnings only) ==="
          kubectl get events -A --field-selector type=Warning --sort-by='.lastTimestamp' || true
          echo "=== Webhook configurations ==="
          kubectl get validatingwebhookconfigurations,mutatingwebhookconfigurations || true
          echo "=== kserve-system ==="
          kubectl get pods -n kserve-system || true
          kubectl describe pods -n kserve-system || true
          kubectl logs -n kserve-system -l control-plane=kserve-controller-manager --tail=100 || true
          echo "=== cert-manager ==="
          kubectl get pods -n cert-manager || true
          kubectl get certificates -A || true
          echo "=== Node resources ==="
          kubectl describe nodes | grep -A 5 "Allocated resources" || true
