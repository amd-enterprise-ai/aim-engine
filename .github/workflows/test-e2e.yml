name: E2E Tests

on:
  pull_request:

jobs:
  test-e2e:
    name: test-e2e
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Create Kind cluster
        run: kind create cluster --config hack/kind/config.yaml

      - name: Install Kind dependencies (NFS provisioner)
        run: helmfile sync -f hack/kind/helmfile.yaml.gotmpl

      - name: Install core dependencies
        # KServe helm chart has a race condition: the ValidatingWebhookConfiguration
        # is applied before the webhook pod is ready, causing ClusterServingRuntime
        # creation to fail with "connection refused". Retry handles this since the
        # webhook pod will be ready on second attempt.
        # See: https://github.com/kserve/kserve/issues/3154
        run: helmfile sync -f hack/dependencies/helmfile.yaml.gotmpl || sleep 10 && helmfile sync -f hack/dependencies/helmfile.yaml.gotmpl

      - name: Build operator image
        run: |
          make docker-build IMG=aim-engine:test
          kind load docker-image aim-engine:test --name aim-engine

      - name: Generate Helm chart
        run: make helm

      - name: Install operator via Helm
        run: helm install aim-engine dist/chart --namespace aim-system --create-namespace --set manager.image.repository=aim-engine --set manager.image.tag=test

      - name: Wait for operator to be ready
        run: kubectl wait --for=condition=Available --timeout=120s deployment/aim-engine-controller-manager -n aim-system

      - name: Run Chainsaw tests
        run: chainsaw test tests/e2e/
