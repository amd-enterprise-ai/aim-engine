name: Tests

on:
  pull_request:

permissions:
  contents: read

jobs:
  test-unit:
    name: test-unit
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2
        env:
          # Skip mise.local.toml which contains dev-only tools not needed in CI
          MISE_LOCAL_CONFIG_ALLOWED: "0"

      - name: Cache Go build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: go-build-${{ runner.os }}-${{ hashFiles('**/*.go', 'go.sum') }}
          restore-keys: |
            go-build-${{ runner.os }}-

      # TODO: Consider adding -race flag for race detection (adds 2-10x build time)
      - name: Run tests
        run: go test ./...

  test-e2e:
    name: test-e2e
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          echo "After cleanup:"
          df -h /

      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2
        env:
          # Skip mise.local.toml which contains dev-only tools not needed in CI
          MISE_LOCAL_CONFIG_ALLOWED: "0"

      - name: Cache Go build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: go-build-${{ runner.os }}-${{ hashFiles('**/*.go', 'go.sum') }}
          restore-keys: |
            go-build-${{ runner.os }}-

      - name: Create Kind cluster
        run: kind create cluster --config hack/kind/config.yaml

      - name: Install Kind dependencies (NFS provisioner)
        run: helmfile sync -f hack/kind/helmfile.yaml.gotmpl

      - name: Install core dependencies
        run: helmfile sync -f hack/dependencies/helmfile.yaml.gotmpl

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build operator image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: aim-engine:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Load image into Kind
        run: kind load docker-image aim-engine:test --name aim-engine

      - name: Generate CRDs
        run: make crds

      - name: Generate Helm chart
        run: make helm

      - name: Install CRDs
        run: kubectl apply -f dist/crds.yaml

      - name: Install operator via Helm
        run: helm install aim-engine dist/chart --namespace aim-system --create-namespace --set manager.image.repository=aim-engine --set manager.image.tag=test

      - name: Wait for operator to be ready
        run: kubectl wait --for=condition=Available --timeout=120s deployment/aim-engine-controller-manager -n aim-system

      - name: Debug operator status
        if: always()
        run: |
          echo "=== Operator Deployment ==="
          kubectl get deployment -n aim-system
          echo "=== Operator Pods ==="
          kubectl get pods -n aim-system
          echo "=== Operator Pod Describe ==="
          kubectl describe pods -n aim-system -l control-plane=controller-manager || true
          echo "=== Operator Logs (last 50 lines) ==="
          kubectl logs -n aim-system -l control-plane=controller-manager --tail=50 || true
          echo "=== CRDs ==="
          kubectl get crds | grep aim || true

      - name: Run Chainsaw tests
        run: make test-chainsaw-kind

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Operator Logs (full) ==="
          kubectl logs -n aim-system -l control-plane=controller-manager --tail=200 || true
          echo "=== All AIM resources ==="
          kubectl get aimservice,aimmodel,aimtemplatecache,aimartifact -A || true
