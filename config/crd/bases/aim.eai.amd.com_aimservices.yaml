---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: aimservices.aim.eai.amd.com
spec:
  group: aim.eai.amd.com
  names:
    categories:
    - aim
    - all
    kind: AIMService
    listKind: AIMServiceList
    plural: aimservices
    shortNames:
    - aimsvc
    singular: aimservice
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.status
      name: Status
      type: string
    - jsonPath: .status.resolvedModel.name
      name: Model
      type: string
    - jsonPath: .status.resolvedTemplate.name
      name: Template
      type: string
    - jsonPath: .spec.replicas
      name: Replicas
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          AIMService manages a KServe-based AIM inference service for the selected model and template.
          Note: KServe uses {name}-{namespace} format which must not exceed 63 characters.
          This constraint is validated at runtime since CEL cannot access metadata.namespace.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              AIMServiceSpec defines the desired state of AIMService.

              Binds a canonical model to an AIMServiceTemplate and configures replicas,
              caching behavior, and optional overrides. The template governs the base
              runtime selection knobs, while the overrides field allows service-specific
              customization.
            properties:
              cacheModel:
                description: |-
                  DEPRECATED: Use Caching.Mode instead. This field will be removed in a future version.
                  For backward compatibility, if Caching is not set, this field is used.
                  Tri-state logic: nil=Auto, true=Always, false=Never
                type: boolean
              caching:
                description: |-
                  Caching controls caching behavior for this service.
                  When nil, defaults to Auto mode (use cache if available, don't create).
                properties:
                  mode:
                    default: Auto
                    description: |-
                      Mode controls when to use caching.
                      - Auto (default): Use cache if it exists, but don't create one
                      - Always: Always use cache, create if it doesn't exist
                      - Never: Don't use cache even if it exists
                    enum:
                    - Auto
                    - Always
                    - Never
                    type: string
                type: object
              imagePullSecrets:
                description: ImagePullSecrets references secrets for pulling AIM container
                  images.
                items:
                  description: |-
                    LocalObjectReference contains enough information to let you locate the
                    referenced object inside the same namespace.
                  properties:
                    name:
                      default: ""
                      description: |-
                        Name of the referent.
                        This field is effectively required, but due to backwards compatibility is
                        allowed to be empty. Instances of this type with an empty value here are
                        almost certainly wrong.
                        More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                      type: string
                  type: object
                  x-kubernetes-map-type: atomic
                type: array
              model:
                description: |-
                  Model specifies which model to deploy using one of the available reference methods.
                  Use `ref` to reference an existing AIMModel/AIMClusterModel by name, or use `image`
                  to specify a container image URI directly (which will auto-create a model if needed).
                properties:
                  image:
                    description: |-
                      Image specifies a container image URI directly.
                      The controller searches for an existing model with this image, or creates one if none exists.
                      The scope of the created model is controlled by the runtime config's ModelCreationScope field.
                      Example: `ghcr.io/silogen/llama-3-8b:v1.2.0`
                    type: string
                  name:
                    description: |-
                      Name references an existing AIMModel or AIMClusterModel by metadata.name.
                      The controller looks for a namespace-scoped AIMModel first, then falls back to cluster-scoped AIMClusterModel.
                      Example: `meta-llama-3-8b`
                    type: string
                type: object
                x-kubernetes-validations:
                - message: exactly one of ref, image, or custom must be specified
                  rule: (has(self.ref) && !has(self.image) && !has(self.custom)) ||
                    (!has(self.ref) && has(self.image) && !has(self.custom)) || (!has(self.ref)
                    && !has(self.image) && has(self.custom))
                - message: model selection is immutable after creation
                  rule: self == oldSelf
              overrides:
                description: |-
                  Overrides allows overriding specific template parameters for this service.
                  When specified, these values take precedence over the template values.
                properties:
                  gpuSelector:
                    description: |-
                      GpuSelector specifies GPU requirements for each replica.
                      Defines the GPU count and model type required for deployment.
                      This field is immutable after creation.
                    properties:
                      count:
                        description: |-
                          Count is the number of GPU resources requested per replica.
                          Must be at least 1.
                        format: int32
                        minimum: 1
                        type: integer
                      model:
                        description: |-
                          Model is the GPU model name required for this deployment.
                          Examples: `MI300X`, `MI325X`
                        minLength: 1
                        type: string
                    required:
                    - count
                    - model
                    type: object
                    x-kubernetes-validations:
                    - message: gpuSelector is immutable
                      rule: self == oldSelf
                  metric:
                    allOf:
                    - enum:
                      - latency
                      - throughput
                    - enum:
                      - latency
                      - throughput
                    description: |-
                      Metric selects the optimization goal.

                      - `latency`: prioritize low end‑to‑end latency
                      - `throughput`: prioritize sustained requests/second
                    type: string
                    x-kubernetes-validations:
                    - message: metric is immutable
                      rule: self == oldSelf
                  precision:
                    allOf:
                    - enum:
                      - bf16
                      - fp16
                      - fp8
                      - int8
                    - enum:
                      - auto
                      - fp4
                      - fp8
                      - fp16
                      - fp32
                      - bf16
                      - int4
                      - int8
                    description: Precision selects the numeric precision used by the
                      runtime.
                    type: string
                    x-kubernetes-validations:
                    - message: precision is immutable
                      rule: self == oldSelf
                type: object
              replicas:
                default: 1
                description: |-
                  Replicas specifies the number of replicas for this service.
                  When not specified, defaults to 1 replica.
                  This value overrides any replica settings from the template.
                format: int32
                type: integer
              resources:
                description: |-
                  Resources overrides the container resource requirements for this service.
                  When specified, these values take precedence over the template and image defaults.
                properties:
                  claims:
                    description: |-
                      Claims lists the names of resources, defined in spec.resourceClaims,
                      that are used by this container.

                      This field depends on the
                      DynamicResourceAllocation feature gate.

                      This field is immutable. It can only be set for containers.
                    items:
                      description: ResourceClaim references one entry in PodSpec.ResourceClaims.
                      properties:
                        name:
                          description: |-
                            Name must match the name of one entry in pod.spec.resourceClaims of
                            the Pod where this field is used. It makes that resource available
                            inside a container.
                          type: string
                        request:
                          description: |-
                            Request is the name chosen for a request in the referenced claim.
                            If empty, everything from the claim is made available, otherwise
                            only the result of this request.
                          type: string
                      required:
                      - name
                      type: object
                    type: array
                    x-kubernetes-list-map-keys:
                    - name
                    x-kubernetes-list-type: map
                  limits:
                    additionalProperties:
                      anyOf:
                      - type: integer
                      - type: string
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    description: |-
                      Limits describes the maximum amount of compute resources allowed.
                      More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                    type: object
                  requests:
                    additionalProperties:
                      anyOf:
                      - type: integer
                      - type: string
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    description: |-
                      Requests describes the minimum amount of compute resources required.
                      If Requests is omitted for a container, it defaults to Limits if that is explicitly specified,
                      otherwise to an implementation-defined value. Requests cannot exceed Limits.
                      More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                    type: object
                type: object
              routing:
                description: |-
                  Routing controls HTTP routing configuration for this service.
                  When set, these values override namespace/cluster runtime config defaults.
                properties:
                  annotations:
                    additionalProperties:
                      type: string
                    description: |-
                      Annotations defines default annotations to add to all HTTPRoute resources.
                      Services can add additional annotations or override these via spec.routingAnnotations.
                      When both are specified, service annotations take precedence for conflicting keys.
                      Common use cases include ingress controller settings, rate limiting, monitoring labels,
                      and security policies that should apply to all services using this config.
                    type: object
                  enabled:
                    description: |-
                      Enabled controls whether HTTP routing is managed for inference services using this config.
                      When true, the operator creates HTTPRoute resources for services that reference this config.
                      When false or unset, routing must be explicitly enabled on each service.
                      This provides a namespace or cluster-wide default that individual services can override.
                    type: boolean
                  gatewayRef:
                    description: |-
                      GatewayRef specifies the Gateway API Gateway resource that should receive HTTPRoutes.
                      This identifies the parent gateway for routing traffic to inference services.
                      The gateway can be in any namespace (cross-namespace references are supported).
                      If routing is enabled but GatewayRef is not specified, service reconciliation will fail
                      with a validation error.
                    properties:
                      group:
                        default: gateway.networking.k8s.io
                        description: |-
                          Group is the group of the referent.
                          When unspecified, "gateway.networking.k8s.io" is inferred.
                          To set the core API group (such as for a "Service" kind referent),
                          Group must be explicitly set to "" (empty string).

                          Support: Core
                        maxLength: 253
                        pattern: ^$|^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                        type: string
                      kind:
                        default: Gateway
                        description: |-
                          Kind is kind of the referent.

                          There are two kinds of parent resources with "Core" support:

                          * Gateway (Gateway conformance profile)
                          * Service (Mesh conformance profile, ClusterIP Services only)

                          Support for other resources is Implementation-Specific.
                        maxLength: 63
                        minLength: 1
                        pattern: ^[a-zA-Z]([-a-zA-Z0-9]*[a-zA-Z0-9])?$
                        type: string
                      name:
                        description: |-
                          Name is the name of the referent.

                          Support: Core
                        maxLength: 253
                        minLength: 1
                        type: string
                      namespace:
                        description: |-
                          Namespace is the namespace of the referent. When unspecified, this refers
                          to the local namespace of the Route.

                          Note that there are specific rules for ParentRefs which cross namespace
                          boundaries. Cross-namespace references are only valid if they are explicitly
                          allowed by something in the namespace they are referring to. For example:
                          Gateway has the AllowedRoutes field, and ReferenceGrant provides a
                          generic way to enable any other kind of cross-namespace reference.

                          <gateway:experimental:description>
                          ParentRefs from a Route to a Service in the same namespace are "producer"
                          routes, which apply default routing rules to inbound connections from
                          any namespace to the Service.

                          ParentRefs from a Route to a Service in a different namespace are
                          "consumer" routes, and these routing rules are only applied to outbound
                          connections originating from the same namespace as the Route, for which
                          the intended destination of the connections are a Service targeted as a
                          ParentRef of the Route.
                          </gateway:experimental:description>

                          Support: Core
                        maxLength: 63
                        minLength: 1
                        pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                        type: string
                      port:
                        description: |-
                          Port is the network port this Route targets. It can be interpreted
                          differently based on the type of parent resource.

                          When the parent resource is a Gateway, this targets all listeners
                          listening on the specified port that also support this kind of Route(and
                          select this Route). It's not recommended to set `Port` unless the
                          networking behaviors specified in a Route must apply to a specific port
                          as opposed to a listener(s) whose port(s) may be changed. When both Port
                          and SectionName are specified, the name and port of the selected listener
                          must match both specified values.

                          <gateway:experimental:description>
                          When the parent resource is a Service, this targets a specific port in the
                          Service spec. When both Port (experimental) and SectionName are specified,
                          the name and port of the selected port must match both specified values.
                          </gateway:experimental:description>

                          Implementations MAY choose to support other parent resources.
                          Implementations supporting other types of parent resources MUST clearly
                          document how/if Port is interpreted.

                          For the purpose of status, an attachment is considered successful as
                          long as the parent resource accepts it partially. For example, Gateway
                          listeners can restrict which Routes can attach to them by Route kind,
                          namespace, or hostname. If 1 of 2 Gateway listeners accept attachment
                          from the referencing Route, the Route MUST be considered successfully
                          attached. If no Gateway listeners accept attachment from this Route,
                          the Route MUST be considered detached from the Gateway.

                          Support: Extended
                        format: int32
                        maximum: 65535
                        minimum: 1
                        type: integer
                      sectionName:
                        description: |-
                          SectionName is the name of a section within the target resource. In the
                          following resources, SectionName is interpreted as the following:

                          * Gateway: Listener name. When both Port (experimental) and SectionName
                          are specified, the name and port of the selected listener must match
                          both specified values.
                          * Service: Port name. When both Port (experimental) and SectionName
                          are specified, the name and port of the selected listener must match
                          both specified values.

                          Implementations MAY choose to support attaching Routes to other resources.
                          If that is the case, they MUST clearly document how SectionName is
                          interpreted.

                          When unspecified (empty string), this will reference the entire resource.
                          For the purpose of status, an attachment is considered successful if at
                          least one section in the parent resource accepts it. For example, Gateway
                          listeners can restrict which Routes can attach to them by Route kind,
                          namespace, or hostname. If 1 of 2 Gateway listeners accept attachment from
                          the referencing Route, the Route MUST be considered successfully
                          attached. If no Gateway listeners accept attachment from this Route, the
                          Route MUST be considered detached from the Gateway.

                          Support: Core
                        maxLength: 253
                        minLength: 1
                        pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                        type: string
                    required:
                    - name
                    type: object
                  pathTemplate:
                    description: |-
                      PathTemplate defines the HTTP path template for routes, evaluated using JSONPath expressions.
                      The template is rendered against the AIMService object to generate unique paths.

                      Example templates:
                      - `/{.metadata.namespace}/{.metadata.name}` - namespace and service name
                      - `/{.metadata.namespace}/{.metadata.labels['team']}/inference` - with label
                      - `/models/{.spec.aimModelName}` - based on model name

                      The template must:
                      - Use valid JSONPath expressions wrapped in {...}
                      - Reference fields that exist on the service
                      - Produce a path ≤ 200 characters after rendering
                      - Result in valid URL path segments (lowercase, RFC 1123 compliant)

                      If evaluation fails, the service enters Degraded state with PathTemplateInvalid reason.
                      Individual services can override this template via spec.routing.pathTemplate.
                    type: string
                  requestTimeout:
                    description: |-
                      RequestTimeout defines the HTTP request timeout for routes.
                      This sets the maximum duration for a request to complete before timing out.
                      The timeout applies to the entire request/response cycle.
                      If not specified, no timeout is set on the route.
                      Individual services can override this value via spec.routing.requestTimeout.
                    type: string
                type: object
              runtimeConfigName:
                description: |-
                  Name is the name of the runtime config to use for this resource. If a runtime config with this name exists both
                  as a namespace and a cluster runtime config, the values are merged together, the namespace config taking priority
                  over the cluster config when there are conflicts. If this field is empty or set to `default`, the namespace / cluster
                  runtime config with the name `default` is used, if it exists.
                type: string
              serviceAccountName:
                description: |-
                  ServiceAccountName specifies the Kubernetes service account to use for the inference workload.
                  This service account is used by the deployed inference pods.
                  If empty, the default service account for the namespace is used.
                type: string
              storage:
                description: |-
                  Storage configures storage defaults for this service's PVCs and caches.
                  When set, these values override namespace/cluster runtime config defaults.
                properties:
                  defaultStorageClassName:
                    description: |-
                      DefaultStorageClassName specifies the storage class to use for model caches and PVCs
                      when the consuming resource (AIMModelCache, AIMTemplateCache, AIMServiceTemplate) does not
                      specify a storage class. If this field is empty, the cluster's default storage class is used.
                    type: string
                  pvcHeadroomPercent:
                    default: 10
                    description: |-
                      PVCHeadroomPercent specifies the percentage of extra space to add to PVCs
                      for model storage. This accounts for filesystem overhead and temporary files
                      during model loading. The value represents a percentage (e.g., 10 means 10% extra space).
                      If not specified, defaults to 10%.
                    format: int32
                    minimum: 0
                    type: integer
                type: object
              template:
                description: |-
                  Template contains template selection and configuration.
                  Use Template.Name to specify an explicit template, or omit to auto-select.
                properties:
                  allowUnoptimized:
                    description: |-
                      AllowUnoptimized, if true, will allow automatic selection of templates
                      that resolve to an unoptimized profile.
                    type: boolean
                  name:
                    description: |-
                      Name is the name of the AIMServiceTemplate or AIMClusterServiceTemplate to use.
                      The template selects the runtime profile and GPU parameters.
                      When not specified, a template will be automatically selected based on the model.
                    type: string
                type: object
            required:
            - model
            type: object
          status:
            description: AIMServiceStatus defines the observed state of AIMService.
            properties:
              cache:
                description: Cache captures cache-related status for this service.
                properties:
                  retryAttempts:
                    description: |-
                      RetryAttempts tracks how many times this service has attempted to retry a failed cache.
                      Each service gets exactly one retry attempt. When a TemplateCache enters Failed state,
                      this counter is incremented from 0 to 1 after deleting failed ModelCaches.
                      If the retry fails (cache enters Failed again with attempts == 1), the service degrades.
                    type: integer
                  templateCacheRef:
                    description: TemplateCacheRef references the TemplateCache being
                      used, if any.
                    properties:
                      kind:
                        description: Kind is the fully-qualified kind of the resolved
                          reference, when known.
                        type: string
                      name:
                        description: Name is the resource name that satisfied the
                          reference.
                        type: string
                      namespace:
                        description: |-
                          Namespace identifies where the resource was found when namespace-scoped.
                          Empty indicates a cluster-scoped resource.
                        type: string
                      scope:
                        description: Scope indicates whether the resolved resource
                          was namespace or cluster scoped.
                        enum:
                        - Namespace
                        - Cluster
                        - Merged
                        - Unknown
                        type: string
                      uid:
                        description: UID captures the unique identifier of the resolved
                          reference, when known.
                        type: string
                    type: object
                type: object
              conditions:
                description: Conditions represent the latest observations of template
                  state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              observedGeneration:
                description: ObservedGeneration is the most recent generation observed
                  by the controller.
                format: int64
                type: integer
              resolvedModel:
                description: ResolvedModel captures metadata about the image that
                  was resolved.
                properties:
                  kind:
                    description: Kind is the fully-qualified kind of the resolved
                      reference, when known.
                    type: string
                  name:
                    description: Name is the resource name that satisfied the reference.
                    type: string
                  namespace:
                    description: |-
                      Namespace identifies where the resource was found when namespace-scoped.
                      Empty indicates a cluster-scoped resource.
                    type: string
                  scope:
                    description: Scope indicates whether the resolved resource was
                      namespace or cluster scoped.
                    enum:
                    - Namespace
                    - Cluster
                    - Merged
                    - Unknown
                    type: string
                  uid:
                    description: UID captures the unique identifier of the resolved
                      reference, when known.
                    type: string
                type: object
              resolvedRuntimeConfig:
                description: ResolvedRuntimeConfig captures metadata about the runtime
                  config that was resolved.
                properties:
                  kind:
                    description: Kind is the fully-qualified kind of the resolved
                      reference, when known.
                    type: string
                  name:
                    description: Name is the resource name that satisfied the reference.
                    type: string
                  namespace:
                    description: |-
                      Namespace identifies where the resource was found when namespace-scoped.
                      Empty indicates a cluster-scoped resource.
                    type: string
                  scope:
                    description: Scope indicates whether the resolved resource was
                      namespace or cluster scoped.
                    enum:
                    - Namespace
                    - Cluster
                    - Merged
                    - Unknown
                    type: string
                  uid:
                    description: UID captures the unique identifier of the resolved
                      reference, when known.
                    type: string
                type: object
              resolvedTemplate:
                description: ResolvedTemplate captures metadata about the template
                  that satisfied the reference.
                properties:
                  kind:
                    description: Kind is the fully-qualified kind of the resolved
                      reference, when known.
                    type: string
                  name:
                    description: Name is the resource name that satisfied the reference.
                    type: string
                  namespace:
                    description: |-
                      Namespace identifies where the resource was found when namespace-scoped.
                      Empty indicates a cluster-scoped resource.
                    type: string
                  scope:
                    description: Scope indicates whether the resolved resource was
                      namespace or cluster scoped.
                    enum:
                    - Namespace
                    - Cluster
                    - Merged
                    - Unknown
                    type: string
                  uid:
                    description: UID captures the unique identifier of the resolved
                      reference, when known.
                    type: string
                type: object
              routing:
                description: Routing surfaces information about the configured HTTP
                  routing, when enabled.
                properties:
                  path:
                    description: |-
                      Path is the HTTP path prefix used when routing is enabled.
                      Example: `/tenant/svc-uuid`
                    type: string
                type: object
              status:
                default: Pending
                description: |-
                  Status represents the current high‑level status of the service lifecycle.
                  Values: `Pending`, `Starting`, `Running`, `Degraded`, `Failed`.
                enum:
                - Pending
                - Starting
                - Running
                - Degraded
                - Failed
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
